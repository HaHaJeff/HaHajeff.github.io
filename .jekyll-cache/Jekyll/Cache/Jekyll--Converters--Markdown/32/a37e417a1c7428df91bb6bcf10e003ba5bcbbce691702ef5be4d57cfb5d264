I"Í<hr />

<h2 id="introduction">Introduction</h2>

<h2 id="é—®é¢˜">é—®é¢˜</h2>

<h2 id="singleton">Singleton</h2>

<p>â€‹	å•ä¾‹æ¨¡å¼çš„ä¸€ç§ç»å…¸å®ç°å¦‚ä¸‹ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Singleton {
public:
	static Singleton* instance();
	...
private:
	static Singleton* pInstancce;
};

Singleton* Singleton::pInstance = 0;

Singleton* Singleeton::instance() {
    if(pInstance == 0) {
    	pInstance = new Singleton;
    }
    return pInstance;
}
</code></pre></div></div>

<p>â€‹	åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸­ï¼Œä¸Šè¿°ä»£ç èƒ½å¤Ÿååˆ†å‡ºè‰²çš„å®Œæˆä»»åŠ¡ã€‚ç„¶è€Œï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œåˆ™ä¼šå‡ºç°é—®é¢˜ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (pInstance == 0)  // thread A                 if (pInstance == 0) // thread B
</code></pre></div></div>

<p>â€‹	thread Aå’Œthread Béƒ½èƒ½å¤Ÿé¡ºåˆ©è¿›å…¥<strong>pInstance = new Singleton</strong>ï¼Œå› æ­¤ï¼Œæ— æ³•æ­£ç¡®å·¥ä½œã€‚</p>

<p>â€‹	æ–¹å¼1ï¼š<strong>é”çš„æ–¹å¼</strong>é¿å…èµ„æºç«äº‰é—®é¢˜ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Singleton* Singleton::instance() {
	Lock lock;
    if(pInstance == 0) {
    	pInstance = new Singleton;
    }
    return pInstance;
}
</code></pre></div></div>

<p>â€‹	ä¸Šè¿°ä»£ç è™½ç„¶è§£å†³äº†é—®é¢˜ï¼Œä½†æ˜¯å¼€é”€æ¯”è¾ƒå¤§ï¼Œæ¯æ¬¡è°ƒç”¨Singleton::instance()éƒ½éœ€è¦<strong>lock unlock</strong>æ“ä½œï¼ˆ<strong>ç„¶è€Œåªæœ‰ç¬¬ä¸€æ¬¡çš„Singleton::instance()è°ƒç”¨æ˜¯æœ‰æ•ˆçš„</strong>ï¼‰ã€‚äºæ˜¯å‡ºç°äº†<strong>double checked locking patter</strong></p>

<h2 id="dclp">DCLP</h2>

<p>â€‹	<strong>double checked locking pattern</strong>ä½œä¸ºä¸€ç§è§£å†³<strong>çº¿ç¨‹å®‰å…¨</strong>é—®é¢˜çš„ç»å…¸æ¨¡å¼ï¼Œå¸¸å¸¸è¢«ç”¨äº<strong>singleton</strong>ï¼Œç»å…¸ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Singleton {
public:
	static Singleton* instance();
	...
private:
	static Singleton* pInstancce;
};

Singleton* Singleton::pInstance = 0;

Singleton* Singleeton::instance() {
    if(pInstance == 0) {			// 1st test
        Lock lock;
        if (pInstance == 0) {		// 2st test
            pInstance = new Singleton;
        }
    }
    return pInstance;
}
</code></pre></div></div>

<p>â€‹	ç›¸æ¯”äºæ–¹å¼1ï¼Œæœ¬æ–¹å¼ä¸éœ€è¦æ¯æ¬¡éƒ½è°ƒç”¨lockã€‚</p>

<ul>
  <li>1st testï¼šç¬¬ä¸€æ¬¡åˆ¤æ–­<strong>pInstance==0</strong>æ˜¯ä¸ºäº†å‡å°‘lockè¢«è°ƒç”¨çš„æ¬¡æ•°</li>
  <li>2st testï¼šç¬¬äºŒæ¬¡åˆ¤æ–­<strong>pInstance==0</strong>æ˜¯ä¸ºäº†çº¿ç¨‹å®‰å…¨ï¼Œè€ƒè™‘ï¼Œthread Aå®Œæˆäº†1st testï¼ˆä½†æ˜¯æ²¡æœ‰lockï¼‰ï¼Œthread Bå®Œæˆäº†1st testï¼ˆæ²¡æœ‰lockï¼‰ï¼Œæ­¤æ—¶thread Aç»§ç»­æ‰§è¡Œnew Singletonï¼Œå¦‚æœæ²¡æœ‰2st testï¼Œthread Bä¹Ÿå°†æˆåŠŸè°ƒç”¨new Singletonï¼Œè¿åsingletonæ¨¡å¼å®šä¹‰</li>
</ul>

<h2 id="dclpå’ŒæŒ‡ä»¤æ‰§è¡Œé¡ºåº">DCLPå’ŒæŒ‡ä»¤æ‰§è¡Œé¡ºåº</h2>

<p>â€‹	ç„¶è€Œï¼Œä¸Šè¿°DCLPä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œè€ƒè™‘å¦‚ä¸‹æŒ‡ä»¤ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pInstance = new Singleton;
</code></pre></div></div>

<p>â€‹	ä¸Šè¿°æŒ‡ä»¤å¯ä»¥åˆ†ä¸ºä¸‰æ­¥ï¼Œå¦‚ä¸‹ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pInstance = 						//step3
	operatro new(sizeof Singleton);	//step1
	new (pInstance) Singleton;		//step2
</code></pre></div></div>

<ul>
  <li>step1ï¼šåˆ†é…ä¿å­˜Singletonå¯¹è±¡çš„å†…å­˜</li>
  <li>step2ï¼šæ„é€ ä¸€ä¸ªSingletonå¯¹è±¡</li>
  <li>step3ï¼šå°†pInstanceæŒ‡å‘è¯¥å—å·²ç»å®Œæˆæ„é€ å†…å­˜</li>
</ul>

<p>â€‹        é€šå¸¸æ¥è¯´ï¼Œç¼–è¯‘å™¨ä¸ä¼šå°†step2æå‰åˆ°step1æ‰§è¡Œã€‚ï¼ˆå› ä¸ºæ„é€ å‡½æ•°å¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæ­¤æ—¶éœ€è¦ç¡®ä¿pInstanceæ²¡æœ‰è¢«ä¿®æ”¹ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨ä¸ºäº†ä¿è¯ç¨‹åºçš„å¼‚å¸¸å®‰å…¨æ€§ï¼Œä¸ä¼šæ“…è‡ªæ”¹å˜æŒ‡ä»¤é¡ºåºã€‚ç„¶è€Œï¼Œåœ¨æŸäº›æ¡ä»¶ä¸‹ï¼Œè¿™ç§æŒ‡ä»¤ä¹±åºæ˜¯å­˜åœ¨çš„ã€‚ï¼‰</p>

<p>â€‹	ç°åœ¨è€ƒè™‘å¦‚ä¸‹åœºæ™¯ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>threadAæ‰§è¡Œäº†step3å’Œstep1åçº¿ç¨‹æŒ‚èµ·
threadBæ‰§è¡Œï¼Œå‘ç°pInstanceä¸ä¸º0ï¼Œäºæ˜¯å¯¹pInsatenceè¿›è¡Œè§£å¼•ç”¨æ“ä½œ
</code></pre></div></div>

<p>â€‹	ä¸Šè¿°è¡Œä¸ºæ˜¯æœªå®šä¹‰çš„ï¼Œå› ä¸ºæ„é€ å‡½æ•°è¿˜æ²¡æœ‰è¢«è°ƒç”¨ã€‚</p>

<h2 id="çœ‹ä¼¼çº¿ç¨‹å®‰å…¨çš„dclp">çœ‹ä¼¼çº¿ç¨‹å®‰å…¨çš„DCLP</h2>

<p>â€‹	DCLPä¹‹æ‰€ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„åŸå› åœ¨äº<strong>æŒ‡ä»¤æ‰§è¡Œé¡ºåº</strong>ï¼Œæ— æ³•ç¡®å®špInstanceæ‰€æŒ‡å‘å†…å­˜ç©ºé—´æ˜¯å¦å¯ç”¨ï¼Œé‚£ä¹ˆä½¿ç”¨ä¸´æ—¶å˜é‡æ˜¯å¦å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿä»£ç å¦‚ä¸‹ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Singleton {
public:
	static Singleton* instance();
	...
private:
	static Singleton* pInstancce;
};

Singleton* Singleton::pInstance = 0;

Singleton* Singleeton::instance() {
    if(pInstance == 0) {		
        Lock lock;
        if (pInstance == 0) {	
        	Singleton* tmp = new Singleton;
            pInstance = tmp;
        }
    }
    return pInstance;
}
</code></pre></div></div>

<p>â€‹	ç­”æ¡ˆæ˜¯ï¼š<strong>ä¸è¡Œ</strong>ã€‚å› ä¸ºç¼–è¯‘å™¨åˆ†æä»£ç åå‘ç°tmpæ˜¯æ— ç”¨çš„ï¼Œæ‰€ä»¥tmpå˜é‡ä¼šè¢«ç§»é™¤ã€‚</p>

<h2 id="å‚è€ƒ">å‚è€ƒ</h2>

<p>[1] <a href="https://https://www.aristeia.com/Papers/DDJ_Jul_Aug_2004_revised.pdf">C++ and the Perils of Double-Checked Locking</a></p>

:ET